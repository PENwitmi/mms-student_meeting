# 学生アカウント管理機能 実装計画書

## 概要
管理者が学生アカウントを作成・管理し、学生の初回ログイン時にパスワード変更を強制する機能を実装します。

## 必要な機能

### 1. 管理者機能
- 学生アカウントの新規作成
- 初期パスワードの設定
- 学生情報の編集（名前、学年、クラス等）
- パスワードリセット機能
- 学生一覧の表示と検索

### 2. 学生機能
- 初回ログイン検知
- パスワード変更画面
- パスワード変更の強制
- プロフィール編集（限定的）

## 技術的実装

### Firebase Auth Admin SDK の課題
**重要**: Firebase Admin SDKは**サーバーサイドでのみ**動作し、ブラウザでは使用できません。

### 実装アプローチの選択肢

#### 選択肢1: Firebase Functions（推奨）
**メリット**:
- セキュアな実装
- Admin SDKフル活用
- 本格的な運用に適している

**デメリット**:
- Firebase Functions設定が必要
- デプロイが必要（ローカル開発は複雑）
- 実装時間: 2-3日

#### 選択肢2: クライアント側での代替実装（MVPとして選択）
**メリット**:
- すぐに実装可能
- ローカルで完結
- 実装時間: 1日

**デメリット**:
- セキュリティがやや劣る
- 一時的にログインが必要

## MVPでの実装方針

### アカウント作成フロー
1. 管理者が学生情報を入力（メール、初期パスワード、名前等）
2. Firebase AuthのcreateUserWithEmailAndPasswordを使用
3. Firestoreにユーザー情報を保存（`firstLogin: true`フラグ付き）
4. 管理者は現在のセッションを維持

### 初回ログイン検知とパスワード変更
1. ログイン時に`firstLogin`フラグをチェック
2. trueの場合、パスワード変更画面へリダイレクト
3. パスワード変更後、`firstLogin: false`に更新

## データ構造

### Firestoreユーザードキュメント拡張
```typescript
interface UserProfile {
  uid: string;
  email: string;
  name: string;
  role: 'admin' | 'student';
  studentId?: string;        // 学籍番号
  grade?: number;            // 学年
  class?: string;            // クラス
  firstLogin: boolean;       // 初回ログインフラグ
  passwordChangedAt?: Date;  // パスワード変更日時
  createdBy?: string;        // 作成した管理者のUID
  createdAt: Date;
  updatedAt: Date;
}
```

## 実装スケジュール

### Phase 1: 学生作成機能（4-5時間）
- [ ] StudentManagementSectionコンポーネント
- [ ] CreateStudentFormコンポーネント
- [ ] 学生作成ロジック
- [ ] Firestoreへのデータ保存

### Phase 2: 学生一覧管理（2-3時間）
- [ ] StudentListコンポーネント
- [ ] 検索・フィルタ機能
- [ ] 編集・削除機能
- [ ] パスワードリセット機能

### Phase 3: 初回ログイン処理（2-3時間）
- [ ] ログイン時のfirstLoginチェック
- [ ] PasswordChangeコンポーネント
- [ ] 強制リダイレクトロジック
- [ ] パスワード変更API

### Phase 4: テストと改善（1-2時間）
- [ ] エラーハンドリング
- [ ] UIの改善
- [ ] ドキュメント作成

## 予想実装時間
**合計: 約10-13時間（1.5-2日）**

## セキュリティ考慮事項

### MVPでの制限
1. 初期パスワードは管理者が設定（自動生成も可能）
2. パスワードは画面に表示され、管理者が学生に伝える必要がある
3. メール通知機能は未実装

### 将来の改善案
1. Firebase Functionsでサーバーサイド実装
2. メールでの初期パスワード通知
3. パスワードリセットリンク送信
4. 二要素認証

## コンポーネント構成

```
src/features/students/
├── components/
│   ├── StudentManagementSection.tsx  # メインセクション
│   ├── CreateStudentForm.tsx        # 学生作成フォーム
│   ├── StudentList.tsx              # 学生一覧
│   ├── StudentCard.tsx              # 学生カード
│   ├── EditStudentModal.tsx         # 編集モーダル
│   └── PasswordResetDialog.tsx      # パスワードリセット
├── hooks/
│   ├── useStudentManagement.ts      # 学生管理フック
│   └── usePasswordChange.ts         # パスワード変更フック
└── utils/
    └── studentValidation.ts         # バリデーション

src/pages/
└── PasswordChange.tsx               # パスワード変更画面
```

## UI/UXデザイン

### 学生作成フォーム
- メールアドレス（必須、一意性チェック）
- 名前（必須）
- 学籍番号（必須、一意性チェック）
- 学年（必須、1-3）
- クラス（任意）
- 初期パスワード（自動生成 or 手動入力）
- パスワード表示/非表示トグル

### 学生一覧
- カード形式で表示
- 検索バー（名前、メール、学籍番号）
- フィルタ（学年、クラス）
- アクション（編集、パスワードリセット、削除）

### パスワード変更画面
- 現在のパスワード入力
- 新しいパスワード入力
- パスワード確認入力
- パスワード強度インジケータ
- 変更必須のメッセージ表示

## 実装の優先順位

1. **必須機能（MVP）**
   - 学生アカウント作成
   - 初回ログイン検知
   - パスワード変更強制

2. **推奨機能**
   - 学生一覧表示
   - 学生情報編集
   - パスワードリセット

3. **将来実装**
   - メール通知
   - バルク作成（CSV取り込み）
   - アカウント無効化
   - ログイン履歴

## リスクと対策

### リスク1: セキュリティ
- 初期パスワードの管理
- **対策**: 強力なパスワード生成、即座の変更強制

### リスク2: 誤操作
- 間違った学生情報の登録
- **対策**: 編集機能、削除前の確認

### リスク3: パフォーマンス
- 大量の学生データ
- **対策**: ページネーション、検索最適化

## 成功指標
- [ ] 管理者が学生アカウントを作成できる
- [ ] 学生が初回ログイン時にパスワード変更を強制される
- [ ] パスワード変更後、通常のダッシュボードにアクセスできる
- [ ] 学生情報が正しくFirestoreに保存される
- [ ] エラー時に適切なメッセージが表示される